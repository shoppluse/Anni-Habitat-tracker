// ----- CAT MASCOT: celebrate on completion + auto-walk + drag -----
const catContainer = document.getElementById("catContainer");
const catBody = document.getElementById("catBody");
const catHearts = document.getElementById("catHearts");

function celebrateCat() {
  catBody.classList.add("cat-dance");
  catHearts.classList.add("cat-hearts-visible");
  setTimeout(() => {
    catBody.classList.remove("cat-dance");
    catHearts.classList.remove("cat-hearts-visible");
  }, 1500);
}

// hook celebrateCat() is already called inside the cell click handler
// when a habit becomes done (from the last code).

// DRAG: when user drags, temporarily stop auto-walk and let them place the cat
let dragOffsetX = 0;
let dragOffsetY = 0;
let dragging = false;

function startDrag(e) {
  dragging = true;
  catContainer.style.cursor = "grabbing";

  // freeze walking animation at current position
  const rect = catContainer.getBoundingClientRect();
  const computed = window.getComputedStyle(catContainer);
  const matrix = new DOMMatrixReadOnly(computed.transform);
  const currentX = matrix.m41;
  const currentY = matrix.m42;

  catContainer.style.animation = "none";
  catContainer.style.transform = `translate(${currentX}px, ${currentY}px)`;

  const clientX = e.touches ? e.touches[0].clientX : e.clientX;
  const clientY = e.touches ? e.touches[0].clientY : e.clientY;
  dragOffsetX = clientX - rect.left;
  dragOffsetY = clientY - rect.top;
}

function onDrag(e) {
  if (!dragging) return;
  e.preventDefault();
  const clientX = e.touches ? e.touches[0].clientX : e.clientX;
  const clientY = e.touches ? e.touches[0].clientY : e.clientY;
  const x = clientX - dragOffsetX;
  const y = clientY - dragOffsetY;
  catContainer.style.left = x + "px";
  catContainer.style.top = y + "px";
  catContainer.style.bottom = "auto";
}

function endDrag() {
  dragging = false;
  catContainer.style.cursor = "grab";
  // resume walking from new place
  catContainer.style.animation = "catWalkPath 14s linear infinite";
}

catContainer.addEventListener("mousedown", startDrag);
window.addEventListener("mousemove", onDrag);
window.addEventListener("mouseup", endDrag);

catContainer.addEventListener("touchstart", startDrag, { passive: false });
window.addEventListener("touchmove", onDrag, { passive: false });
window.addEventListener("touchend", endDrag);
